---
layout: post
title: "Playing with Brushless Motor Field Oriented Control"
image: /images/FOC/gif1.gif
---

This post details some tests I have done using Field Oriented Control (FOC) of BLDC motors.

I often use brushless (BLDC) motors for drone projects as they provide a high power to weight ratio, and fast control of speed. They are however more complex to control than many other types of electric motor, especially at low speeds. This means that accuracte position control has often been done using stepper or servo motors instead, or if brushless motors are used, it is often through large gear reductions. Being able to accurately and precicely control the position of a BLDC motor makes them much more suitable for use in 

Field oriented control (FOC) is a method of driving BLDC motors which provides an increased amount of control and efficiency. Up until recently, BLDC motor drivers which used FOC were either expensive and used closed source software. [SimpleFOC](https://simplefoc.com/) is an open source FOC project, which is Arduino compatable, meaning it is easy to modify and run on a wide range of hardware. Although the project has files and a store with their own BLDC driver hardware, it is intended to be used with a separte Arduino Uno, and it is relatively low power (max 120W), at least compared to what drones or larger robots require.

The [B-G431B-ESC1](https://www.st.com/en/evaluation-tools/b-g431b-esc1.html) is an Electronic Speed Controller (ESC) by ST which features an STM32G431CB microcontroller and other hardware required for field oriented control of brushless motors, in a footprint not much larger or expensive than similarly powerful drone ESCs. With a peak current capability of 40A, it is also much more powerful than the SimpleFOC driver. It is intended to be used with a suite ST applications, but it is also possible to use it with the Arduino IDE, and therefore, the SimpleFOC library. The below image shows the B-G431B-ESC1, where the top section is a removable daughterboard which contains an ST-LINK programmer and a potentiometer, and the lower section is the ESC itself (the STM32G431CB is on the back of the lower ESC board). The daughterboard is able to be snapped off for final use, or it can be left on for easier programming and the use of the potentiometer.

<img src="/images/FOC/B-G431B-ESC1.jpg" alt="" class="inline">

To test SimpleFOC on the B-G431B-ESC1, I connected it to a an EMAX MT3515-650KV BLDC motor.

<img src="/images/FOC/setup1.jpg" alt="" class="inline">

The below video shows a basic postion control test, with the motor returning to the upright position every time the position is manually changed, or when the ESC regains power. It can be seen that the control is not perfect, as there are oscillations during the movement. I think that this is mostly due to the pulseIn() function I am using to read the PWM from the rotation sensor, as it is a blocking function which causes issues with the FOC algorithm loop.

<div class="video-container">
<iframe width="560" height="315" src="https://www.youtube.com/embed/AKeHVLWpUk4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
